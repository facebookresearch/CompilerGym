<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>compiler_gym.envs.llvm.llvm_env &mdash; CompilerGym 0.2.5 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html">
            <img src="../../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rpc.html">RPC Service Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../llvm/index.html">LLVM Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../envs/gcc.html">GCC Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../envs/loop_tool.html">loop_tool Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../envs/mlir.html">MLIR Environment Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/compiler_gym.html">compiler_gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/datasets.html">compiler_gym.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/envs.html">compiler_gym.envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/envs/gcc.html">compiler_gym.envs.gcc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../llvm/api.html">compiler_gym.envs.llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/leaderboard.html">compiler_gym.leaderboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/service.html">compiler_gym.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/service/runtime.html">compiler_gym.service.runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/spaces.html">compiler_gym.spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/views.html">compiler_gym.views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../compiler_gym/wrappers.html">compiler_gym.wrappers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../cc/compiler_gym/envs/llvm/service.html">compiler_gym/envs/llvm/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cc/compiler_gym/service.html">compiler_gym/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cc/compiler_gym/service/runtime.html">compiler_gym/service/runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cc/compiler_gym/util.html">compiler_gym/util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">CompilerGym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>compiler_gym.envs.llvm.llvm_env</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for compiler_gym.envs.llvm.llvm_env</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>
<span class="sd">&quot;&quot;&quot;Extensions to the ClientServiceCompilerEnv environment for LLVM.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">compiler_gym.datasets</span> <span class="kn">import</span> <span class="n">Benchmark</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">compiler_gym.envs.llvm.benchmark_from_command_line</span> <span class="kn">import</span> <span class="n">BenchmarkFromCommandLine</span>
<span class="kn">from</span> <span class="nn">compiler_gym.envs.llvm.datasets</span> <span class="kn">import</span> <span class="n">get_llvm_datasets</span>
<span class="kn">from</span> <span class="nn">compiler_gym.envs.llvm.lexed_ir</span> <span class="kn">import</span> <span class="n">LexedToken</span>
<span class="kn">from</span> <span class="nn">compiler_gym.envs.llvm.llvm_benchmark</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ClangInvocation</span><span class="p">,</span>
    <span class="n">get_system_library_flags</span><span class="p">,</span>
    <span class="n">make_benchmark</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">compiler_gym.envs.llvm.llvm_rewards</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaselineImprovementNormalizedReward</span><span class="p">,</span>
    <span class="n">CostFunctionReward</span><span class="p">,</span>
    <span class="n">NormalizedReward</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">compiler_gym.errors</span> <span class="kn">import</span> <span class="n">BenchmarkInitError</span><span class="p">,</span> <span class="n">SessionNotFound</span>
<span class="kn">from</span> <span class="nn">compiler_gym.service.client_service_compiler_env</span> <span class="kn">import</span> <span class="n">ClientServiceCompilerEnv</span>
<span class="kn">from</span> <span class="nn">compiler_gym.spaces</span> <span class="kn">import</span> <span class="n">Box</span><span class="p">,</span> <span class="n">Commandline</span>
<span class="kn">from</span> <span class="nn">compiler_gym.spaces</span> <span class="kn">import</span> <span class="n">Dict</span> <span class="k">as</span> <span class="n">DictSpace</span>
<span class="kn">from</span> <span class="nn">compiler_gym.spaces</span> <span class="kn">import</span> <span class="n">Scalar</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">compiler_gym.third_party.autophase</span> <span class="kn">import</span> <span class="n">AUTOPHASE_FEATURE_NAMES</span>
<span class="kn">from</span> <span class="nn">compiler_gym.third_party.gccinvocation.gccinvocation</span> <span class="kn">import</span> <span class="n">GccInvocation</span>
<span class="kn">from</span> <span class="nn">compiler_gym.third_party.inst2vec</span> <span class="kn">import</span> <span class="n">Inst2vecEncoder</span>
<span class="kn">from</span> <span class="nn">compiler_gym.third_party.llvm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">clang_path</span><span class="p">,</span>
    <span class="n">download_llvm_files</span><span class="p">,</span>
    <span class="n">llvm_link_path</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">compiler_gym.third_party.llvm.instcount</span> <span class="kn">import</span> <span class="n">INST_COUNT_FEATURE_NAMES</span>
<span class="kn">from</span> <span class="nn">compiler_gym.util.commands</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">compiler_gym.util.runfiles_path</span> <span class="kn">import</span> <span class="n">transient_cache_path</span>
<span class="kn">from</span> <span class="nn">compiler_gym.util.shell_format</span> <span class="kn">import</span> <span class="n">join_cmd</span>

<span class="n">_INST2VEC_ENCODER</span> <span class="o">=</span> <span class="n">Inst2vecEncoder</span><span class="p">()</span>


<span class="n">_LLVM_DATASETS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_llvm_datasets</span><span class="p">(</span><span class="n">site_data_base</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get the LLVM datasets. Use a singleton value when site_data_base is the</span>
<span class="sd">    default value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_LLVM_DATASETS</span>
    <span class="k">if</span> <span class="n">site_data_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_LLVM_DATASETS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LLVM_DATASETS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_llvm_datasets</span><span class="p">(</span><span class="n">site_data_base</span><span class="o">=</span><span class="n">site_data_base</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_LLVM_DATASETS</span>
    <span class="k">return</span> <span class="n">get_llvm_datasets</span><span class="p">(</span><span class="n">site_data_base</span><span class="o">=</span><span class="n">site_data_base</span><span class="p">)</span>


<div class="viewcode-block" id="LlvmEnv"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv">[docs]</a><span class="k">class</span> <span class="nc">LlvmEnv</span><span class="p">(</span><span class="n">ClientServiceCompilerEnv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A specialized ClientServiceCompilerEnv for LLVM.</span>

<span class="sd">    This extends the default :class:`ClientServiceCompilerEnv</span>
<span class="sd">    &lt;compiler_gym.envs.ClientServiceCompilerEnv&gt;` environment, adding extra LLVM</span>
<span class="sd">    functionality. Specifically, the actions use the :class:`CommandlineFlag</span>
<span class="sd">    &lt;compiler_gym.spaces.CommandlineFlag&gt;` space, which is a type of</span>
<span class="sd">    :code:`Discrete` space that provides additional documentation about each</span>
<span class="sd">    action, and the :meth:`LlvmEnv.commandline()</span>
<span class="sd">    &lt;compiler_gym.envs.LlvmEnv.commandline&gt;` method can be used to produce an</span>
<span class="sd">    equivalent LLVM opt invocation for the current environment state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">benchmark</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Benchmark</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">datasets_site_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># First perform a one-time download of LLVM binaries that are needed by</span>
        <span class="c1"># the LLVM service and are not included by the pip-installed package.</span>
        <span class="n">download_llvm_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span> <span class="o">=</span> <span class="n">_INST2VEC_ENCODER</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="c1"># Set a default benchmark for use.</span>
            <span class="n">benchmark</span><span class="o">=</span><span class="n">benchmark</span> <span class="ow">or</span> <span class="s2">&quot;cbench-v1/qsort&quot;</span><span class="p">,</span>
            <span class="n">datasets</span><span class="o">=</span><span class="n">_get_llvm_datasets</span><span class="p">(</span><span class="n">site_data_base</span><span class="o">=</span><span class="n">datasets_site_path</span><span class="p">),</span>
            <span class="n">rewards</span><span class="o">=</span><span class="p">[</span>
                <span class="n">CostFunctionReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO0&quot;</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">NormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountNorm&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO0&quot;</span><span class="p">,</span>
                    <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO3&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO3&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO0&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountOz&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountOz&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;IrInstructionCountO0&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">CostFunctionReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">NormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeNorm&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO0&quot;</span><span class="p">,</span>
                    <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO3&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO3&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeOz&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;ObjectTextSizeOz&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">CostFunctionReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">NormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TextSizeNorm&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeO0&quot;</span><span class="p">,</span>
                    <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TextSizeO3&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeO3&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">BaselineImprovementNormalizedReward</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TextSizeOz&quot;</span><span class="p">,</span>
                    <span class="n">cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeBytes&quot;</span><span class="p">,</span>
                    <span class="n">init_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeO0&quot;</span><span class="p">,</span>
                    <span class="n">baseline_cost_function</span><span class="o">=</span><span class="s2">&quot;TextSizeOz&quot;</span><span class="p">,</span>
                    <span class="n">success_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">default_negates_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">platform_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">derived_observation_spaces</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Inst2vecPreprocessedText&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Ir&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Inst2vecPreprocessedText&quot;</span><span class="p">,</span> <span class="n">size_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">preprocess</span><span class="p">,</span>
                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Inst2vecEmbeddingIndices&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Ir&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Inst2vecEmbeddingIndices&quot;</span><span class="p">,</span>
                        <span class="n">size_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">base_observation</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;!UNK&quot;</span><span class="p">]]),</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Inst2vec&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Ir&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Inst2vec&quot;</span><span class="p">,</span> <span class="n">size_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">base_observation</span><span class="p">))</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inst2vec</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;!UNK&quot;</span><span class="p">]]]</span>
                    <span class="p">),</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCountDict&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCount&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">DictSpace</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Count&quot;</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">INST_COUNT_FEATURE_NAMES</span>
                        <span class="p">},</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;InstCountDict&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Count&quot;</span><span class="p">:</span> <span class="n">val</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">INST_COUNT_FEATURE_NAMES</span><span class="p">,</span> <span class="n">base_observation</span><span class="p">)</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCountNorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCount&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">Box</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;InstCountNorm&quot;</span><span class="p">,</span>
                        <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">INST_COUNT_FEATURE_NAMES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">base_observation</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCountNormDict&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;InstCountNorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">DictSpace</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Density&quot;</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Density&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">INST_COUNT_FEATURE_NAMES</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="p">},</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;InstCountNormDict&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">Density&quot;</span><span class="p">:</span> <span class="n">val</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">INST_COUNT_FEATURE_NAMES</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">base_observation</span>
                        <span class="p">)</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;AutophaseDict&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Autophase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">DictSpace</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="n">name</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">AUTOPHASE_FEATURE_NAMES</span>
                        <span class="p">},</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AutophaseDict&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">name</span><span class="p">:</span> <span class="n">val</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">AUTOPHASE_FEATURE_NAMES</span><span class="p">,</span> <span class="n">base_observation</span><span class="p">)</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LexedIrTuple&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="s2">&quot;LexedIr&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;LexedToken&quot;</span><span class="p">,</span>
                        <span class="n">size_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">LexedToken</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">base_observation</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">LexedToken</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">base_observation</span><span class="p">[</span><span class="s2">&quot;token_id&quot;</span><span class="p">],</span>
                            <span class="n">base_observation</span><span class="p">[</span><span class="s2">&quot;token_kind&quot;</span><span class="p">],</span>
                            <span class="n">base_observation</span><span class="p">[</span><span class="s2">&quot;token_category&quot;</span><span class="p">],</span>
                            <span class="n">base_observation</span><span class="p">[</span><span class="s2">&quot;token_value&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;token_id&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;token_kind&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;token_category&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;token_value&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Mutable runtime configuration options that must be set on every call</span>
        <span class="c1"># to reset.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_per_observation_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_warmup_per_observation_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cpu_info_spaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Sequence</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">size_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cores_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l1i_cache_size&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l1i_cache_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l1d_cache_size&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l1d_cache_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l2_cache_size&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l2_cache_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l3_cache_size&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l3_cache_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l4_cache_size&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l4_cache_count&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;CpuInfo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">DictSpace</span><span class="p">(</span>
            <span class="p">{</span><span class="n">space</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">space</span> <span class="k">for</span> <span class="n">space</span> <span class="ow">in</span> <span class="n">cpu_info_spaces</span><span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CpuInfo&quot;</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LlvmEnv.reset"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch and re-raise some known benchmark initialization errors with</span>
            <span class="c1"># a more informative error type.</span>
            <span class="k">if</span> <span class="s2">&quot;Failed to compute .text size cost&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BenchmarkInitError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to initialize benchmark </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_benchmark_in_use</span><span class="o">.</span><span class="n">uri</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="s2">&quot;File not found:&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">&quot;File is empty:&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">&quot;Error reading file:&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">BenchmarkInitError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="LlvmEnv.make_benchmark"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.make_benchmark">[docs]</a>    <span class="k">def</span> <span class="nf">make_benchmark</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">ClangInvocation</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">ClangInvocation</span><span class="p">]]</span>
        <span class="p">],</span>
        <span class="n">copt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_includes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Benchmark</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a benchmark for use with this environment.</span>

<span class="sd">        This function takes one or more inputs and uses them to create an LLVM</span>
<span class="sd">        bitcode benchmark that can be passed to</span>
<span class="sd">        :meth:`compiler_gym.envs.LlvmEnv.reset`.</span>

<span class="sd">        The following input types are supported:</span>

<span class="sd">        +-----------------------------------------------------+---------------------+-------------------------------------------------------------+</span>
<span class="sd">        | **File Suffix**                                     | **Treated as**      | **Converted using**                                         |</span>
<span class="sd">        +-----------------------------------------------------+---------------------+-------------------------------------------------------------+</span>
<span class="sd">        | :code:`.bc`                                         | LLVM IR bitcode     | No conversion required.                                     |</span>
<span class="sd">        +-----------------------------------------------------+---------------------+-------------------------------------------------------------+</span>
<span class="sd">        | :code:`.ll`                                         | LLVM IR text format | Assembled to bitcode using llvm-as.                         |</span>
<span class="sd">        +-----------------------------------------------------+---------------------+-------------------------------------------------------------+</span>
<span class="sd">        | :code:`.c`, :code:`.cc`, :code:`.cpp`, :code:`.cxx` | C / C++ source      | Compiled to bitcode using clang and the given :code:`copt`. |</span>
<span class="sd">        +-----------------------------------------------------+---------------------+-------------------------------------------------------------+</span>

<span class="sd">        .. note::</span>

<span class="sd">            The LLVM IR format has no compatability guarantees between versions (see</span>
<span class="sd">            `LLVM docs</span>
<span class="sd">            &lt;https://llvm.org/docs/DeveloperPolicy.html#ir-backwards-compatibility&gt;`_).</span>
<span class="sd">            You must ensure that any :code:`.bc` and :code:`.ll` files are</span>
<span class="sd">            compatible with the LLVM version used by CompilerGym, which can be</span>
<span class="sd">            reported using :func:`env.compiler_version</span>
<span class="sd">            &lt;compiler_gym.envs.ClientServiceCompilerEnv.compiler_version&gt;`.</span>

<span class="sd">        E.g. for single-source C/C++ programs, you can pass the path of the source</span>
<span class="sd">        file:</span>

<span class="sd">            &gt;&gt;&gt; benchmark = env.make_benchmark(&#39;my_app.c&#39;)</span>
<span class="sd">            &gt;&gt;&gt; env = gym.make(&quot;llvm-v0&quot;)</span>
<span class="sd">            &gt;&gt;&gt; env.reset(benchmark=benchmark)</span>

<span class="sd">        The clang invocation used is roughly equivalent to:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            $ clang my_app.c -O0 -c -emit-llvm -o benchmark.bc</span>

<span class="sd">        Additional compile-time arguments to clang can be provided using the</span>
<span class="sd">        :code:`copt` argument:</span>

<span class="sd">            &gt;&gt;&gt; benchmark = env.make_benchmark(&#39;/path/to/my_app.cpp&#39;, copt=[&#39;-O2&#39;])</span>

<span class="sd">        If you need more fine-grained control over the options, you can directly</span>
<span class="sd">        construct a :class:`ClangInvocation</span>
<span class="sd">        &lt;compiler_gym.envs.llvm.ClangInvocation&gt;` to pass a list of arguments to</span>
<span class="sd">        clang:</span>

<span class="sd">            &gt;&gt;&gt; benchmark = env.make_benchmark(</span>
<span class="sd">                ClangInvocation([&#39;/path/to/my_app.c&#39;], system_includes=False, timeout=10)</span>
<span class="sd">            )</span>

<span class="sd">        For multi-file programs, pass a list of inputs that will be compiled</span>
<span class="sd">        separately and then linked to a single module:</span>

<span class="sd">            &gt;&gt;&gt; benchmark = env.make_benchmark([</span>
<span class="sd">                &#39;main.c&#39;,</span>
<span class="sd">                &#39;lib.cpp&#39;,</span>
<span class="sd">                &#39;lib2.bc&#39;,</span>
<span class="sd">                &#39;foo/input.bc&#39;</span>
<span class="sd">            ])</span>

<span class="sd">        :param inputs: An input, or list of inputs.</span>

<span class="sd">        :param copt: A list of command line options to pass to clang when</span>
<span class="sd">            compiling source files.</span>

<span class="sd">        :param system_includes: Whether to include the system standard libraries</span>
<span class="sd">            during compilation jobs. This requires a system toolchain. See</span>
<span class="sd">            :func:`get_system_library_flags`.</span>

<span class="sd">        :param timeout: The maximum number of seconds to allow clang to run</span>
<span class="sd">            before terminating.</span>

<span class="sd">        :return: A :code:`Benchmark` instance.</span>

<span class="sd">        :raises FileNotFoundError: If any input sources are not found.</span>

<span class="sd">        :raises TypeError: If the inputs are of unsupported types.</span>

<span class="sd">        :raises OSError: If a suitable compiler cannot be found.</span>

<span class="sd">        :raises BenchmarkInitError: If a compilation job fails.</span>

<span class="sd">        :raises TimeoutExpired: If a compilation job exceeds :code:`timeout`</span>
<span class="sd">            seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">make_benchmark</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">copt</span><span class="o">=</span><span class="n">copt</span><span class="p">,</span>
            <span class="n">system_includes</span><span class="o">=</span><span class="n">system_includes</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LlvmEnv.commandline"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.commandline">[docs]</a>    <span class="k">def</span> <span class="nf">commandline</span><span class="p">(</span>  <span class="c1"># pylint: disable=arguments-differ</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">textformat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns an LLVM :code:`opt` command line invocation for the current</span>
<span class="sd">        environment state.</span>

<span class="sd">        :param textformat: Whether to generate a command line that processes</span>
<span class="sd">            text-format LLVM-IR or bitcode (the default).</span>
<span class="sd">        :returns: A command line string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Commandline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span><span class="o">.</span><span class="n">commandline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">textformat</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;opt </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> input.ll -S -o output.ll&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;opt </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> input.bc -o output.bc&quot;</span></div>

<div class="viewcode-block" id="LlvmEnv.commandline_to_actions"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.commandline_to_actions">[docs]</a>    <span class="k">def</span> <span class="nf">commandline_to_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandline</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of actions from the given command line.</span>

<span class="sd">        :param commandline: A command line invocation, as generated by</span>
<span class="sd">            :meth:`env.commandline() &lt;compiler_gym.envs.LlvmEnv.commandline&gt;`.</span>
<span class="sd">        :return: A list of actions.</span>
<span class="sd">        :raises ValueError: In case the command line string is malformed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Strip the decorative elements that LlvmEnv.commandline() adds.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commandline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;opt &quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid commandline: `</span><span class="si">{</span><span class="n">commandline</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commandline</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot; input.ll -S -o output.ll&quot;</span><span class="p">):</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="n">commandline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;opt &quot;</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot; input.ll -S -o output.ll&quot;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">commandline</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot; input.bc -o output.bc&quot;</span><span class="p">):</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="n">commandline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;opt &quot;</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot; input.bc -o output.bc&quot;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid commandline: `</span><span class="si">{</span><span class="n">commandline</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">from_commandline</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print the LLVM-IR of the program in its current state.</span>

<span class="sd">        Alias for :code:`env.observation[&quot;Ir&quot;]`.</span>

<span class="sd">        :return: A string of LLVM-IR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s2">&quot;Ir&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ir_sha1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the 40-characeter hex sha1 checksum of the current IR.</span>

<span class="sd">        Equivalent to: :code:`hashlib.sha1(env.ir.encode(&quot;utf-8&quot;)).hexdigest()`.</span>

<span class="sd">        :return: A 40-character hexadecimal sha1 string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s2">&quot;IrSha1&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="LlvmEnv.write_ir"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.write_ir">[docs]</a>    <span class="k">def</span> <span class="nf">write_ir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the current program state to a file.</span>

<span class="sd">        :param path: The path of the file to write.</span>
<span class="sd">        :return: The input :code:`path` argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="LlvmEnv.write_bitcode"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.write_bitcode">[docs]</a>    <span class="k">def</span> <span class="nf">write_bitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the current program state to a bitcode file.</span>

<span class="sd">        :param path: The path of the file to write.</span>
<span class="sd">        :return: The input :code:`path` argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="n">tmp_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s2">&quot;BitcodeFile&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="LlvmEnv.render"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;human&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runtime_observation_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The number of runtimes to return for the Runtime observation space.</span>

<span class="sd">        See the :ref:`Runtime observation space reference &lt;llvm/index:Runtime&gt;`</span>
<span class="sd">        for further details.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            &gt;&gt;&gt; env = compiler_gym.make(&quot;llvm-v0&quot;)</span>
<span class="sd">            &gt;&gt;&gt; env.reset()</span>
<span class="sd">            &gt;&gt;&gt; env.runtime_observation_count = 10</span>
<span class="sd">            &gt;&gt;&gt; len(env.observation.Runtime())</span>
<span class="sd">            10</span>

<span class="sd">        :getter: Returns the number of runtimes that will be returned when a</span>
<span class="sd">            :code:`Runtime` observation is requested.</span>

<span class="sd">        :setter: Set the number of runtimes to compute when a :code:`Runtime`</span>
<span class="sd">            observation is requested.</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_per_observation_count</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_param</span><span class="p">(</span><span class="s2">&quot;llvm.get_runtimes_per_observation_count&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@runtime_observation_count</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">runtime_observation_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_param</span><span class="p">(</span>
                <span class="s2">&quot;llvm.set_runtimes_per_observation_count&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">resend_on_reset</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">SessionNotFound</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Not in session yet, will be sent on reset().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_per_observation_count</span> <span class="o">=</span> <span class="n">n</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runtime_warmup_runs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The number of warmup runs of the binary to perform before measuring</span>
<span class="sd">        the Runtime observation space.</span>

<span class="sd">        See the :ref:`Runtime observation space reference &lt;llvm/index:Runtime&gt;`</span>
<span class="sd">        for further details.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            &gt;&gt;&gt; env = compiler_gym.make(&quot;llvm-v0&quot;)</span>
<span class="sd">            &gt;&gt;&gt; env.reset()</span>
<span class="sd">            &gt;&gt;&gt; env.runtime_observation_count = 10</span>
<span class="sd">            &gt;&gt;&gt; len(env.observation.Runtime())</span>
<span class="sd">            10</span>

<span class="sd">        :getter: Returns the number of runs that be performed before measuring</span>
<span class="sd">            the :code:`Runtime` observation is requested.</span>

<span class="sd">        :setter: Set the number of warmup runs to perform when a :code:`Runtime`</span>
<span class="sd">            observation is requested.</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_warmup_per_observation_count</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_param</span><span class="p">(</span><span class="s2">&quot;llvm.get_warmup_runs_count_per_runtime_observation&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@runtime_warmup_runs_count</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">runtime_warmup_runs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_param</span><span class="p">(</span>
                <span class="s2">&quot;llvm.set_warmup_runs_count_per_runtime_observation&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
                <span class="n">resend_on_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">SessionNotFound</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Not in session yet, will be sent on reset().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runtimes_warmup_per_observation_count</span> <span class="o">=</span> <span class="n">n</span>

<div class="viewcode-block" id="LlvmEnv.fork"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.fork">[docs]</a>    <span class="k">def</span> <span class="nf">fork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fkd</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_observation_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fkd</span><span class="o">.</span><span class="n">runtime_observation_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_observation_count</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_warmup_runs_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fkd</span><span class="o">.</span><span class="n">runtime_warmup_runs_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_warmup_runs_count</span>
        <span class="k">return</span> <span class="n">fkd</span></div>

<div class="viewcode-block" id="LlvmEnv.make_benchmark_from_command_line"><a class="viewcode-back" href="../../../../compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.make_benchmark_from_command_line">[docs]</a>    <span class="k">def</span> <span class="nf">make_benchmark_from_command_line</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">replace_driver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">system_includes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Benchmark</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a benchmark for use with this environment.</span>

<span class="sd">        This function takes a command line compiler invocation as input,</span>
<span class="sd">        modifies it to produce an unoptimized LLVM-IR bitcode, and then runs the</span>
<span class="sd">        modified command line to produce a bitcode benchmark.</span>

<span class="sd">        For example, the command line:</span>

<span class="sd">            &gt;&gt;&gt; benchmark = env.make_benchmark_from_command_line(</span>
<span class="sd">            ...     [&quot;gcc&quot;, &quot;-DNDEBUG&quot;, &quot;a.c&quot;, &quot;b.c&quot;, &quot;-o&quot;, &quot;foo&quot;, &quot;-lm&quot;]</span>
<span class="sd">            ... )</span>

<span class="sd">        Will compile a.c and b.c to an unoptimized benchmark that can be then</span>
<span class="sd">        passed to :meth:`reset() &lt;compiler_env.envs.CompilerEnv.reset&gt;`.</span>

<span class="sd">        The way this works is to change the first argument of the command line</span>
<span class="sd">        invocation to the version of clang shipped with CompilerGym, and to then</span>
<span class="sd">        append command line flags that causes the compiler to produce LLVM-IR</span>
<span class="sd">        with optimizations disabled. For example the input command line:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            gcc -DNDEBUG a.c b.c -o foo -lm</span>

<span class="sd">        Will be rewritten to be roughly equivalent to:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            /path/to/compiler_gym/clang -DNDEG a.c b.c \\</span>
<span class="sd">                -Xclang -disable-llvm-passes -Xclang -disable-llvm-optzns \\ -c</span>
<span class="sd">                -emit-llvm  -o -</span>

<span class="sd">        The generated benchmark then has a method :meth:`compile()</span>
<span class="sd">        &lt;compiler_env.envs.llvm.BenchmarkFromCommandLine.compile&gt;` which</span>
<span class="sd">        completes the linking and compilatilion to executable. For the above</span>
<span class="sd">        example, this would be roughly equivalent to:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            /path/to/compiler_gym/clang environment-bitcode.bc -o foo -lm</span>

<span class="sd">        :param cmd: A command line compiler invocation, either as a list of</span>
<span class="sd">            arguments (e.g. :code:`[&quot;clang&quot;, &quot;in.c&quot;]`) or as a single shell</span>
<span class="sd">            string (e.g. :code:`&quot;clang in.c&quot;`).</span>

<span class="sd">        :param replace_driver: Whether to replace the first argument of the</span>
<span class="sd">            command with the clang driver used by this environment.</span>

<span class="sd">        :param system_includes: Whether to include the system standard libraries</span>
<span class="sd">            during compilation jobs. This requires a system toolchain. See</span>
<span class="sd">            :func:`get_system_library_flags`.</span>

<span class="sd">        :param timeout: The maximum number of seconds to allow the compilation</span>
<span class="sd">            job to run before terminating.</span>

<span class="sd">        :return: A :class:`BenchmarkFromCommandLine</span>
<span class="sd">            &lt;compiler_gym.envs.llvm.BenchmarkFromCommandLine&gt;` instance.</span>

<span class="sd">        :raises ValueError: If no command line is provided.</span>

<span class="sd">        :raises BenchmarkInitError: If executing the command line fails.</span>

<span class="sd">        :raises TimeoutExpired: If a compilation job exceeds :code:`timeout`</span>
<span class="sd">            seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input command line is empty&quot;</span><span class="p">)</span>

        <span class="c1"># Split the command line if passed a single string.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="n">rewritten_cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input command line &#39;</span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; is too short&quot;</span><span class="p">)</span>

        <span class="c1"># Append include flags for the system headers if requested.</span>
        <span class="k">if</span> <span class="n">system_includes</span><span class="p">:</span>
            <span class="n">rewritten_cmd</span> <span class="o">+=</span> <span class="n">get_system_library_flags</span><span class="p">()</span>

        <span class="c1"># Use the CompilerGym clang binary in place of the original driver.</span>
        <span class="k">if</span> <span class="n">replace_driver</span><span class="p">:</span>
            <span class="n">rewritten_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">clang_path</span><span class="p">())</span>

        <span class="c1"># Strip the -S flag, if present, as that changes the output format.</span>
        <span class="n">rewritten_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rewritten_cmd</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;-S&quot;</span><span class="p">]</span>

        <span class="n">invocation</span> <span class="o">=</span> <span class="n">GccInvocation</span><span class="p">(</span><span class="n">rewritten_cmd</span><span class="p">)</span>

        <span class="c1"># Strip the output specifier(s). This is not strictly required since we</span>
        <span class="c1"># override it later, but makes the generated command easier to</span>
        <span class="c1"># understand.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rewritten_cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rewritten_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-o&quot;</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">rewritten_cmd</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">rewritten_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Fail early.</span>
        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">invocation</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Input command line reads from stdin, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is not supported: &#39;</span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert all of the C/C++ sources to bitcodes which can then be linked</span>
        <span class="c1"># into a single bitcode. We must process them individually because the</span>
        <span class="c1"># &#39;-c&#39; flag does not support multiple sources when we are specifying the</span>
        <span class="c1"># output path using &#39;-o&#39;.</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">invocation</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.o&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Input command line has no source file inputs: &#39;</span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="n">bitcodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="c1"># Adapt and execute the command line so that it will generate an</span>
            <span class="c1"># unoptimized bitecode file.</span>
            <span class="n">emit_bitcode_command</span> <span class="o">=</span> <span class="n">rewritten_cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Strip the name of other sources:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">emit_bitcode_command</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">emit_bitcode_command</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">source</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span>
                <span class="p">]</span>

            <span class="c1"># Append the flags to emit the bitcode and disable the optimization</span>
            <span class="c1"># passes.</span>
            <span class="n">emit_bitcode_command</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-emit-llvm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-Xclang&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-disable-llvm-passes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-Xclang&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-disable-llvm-optzns&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="k">with</span> <span class="n">Popen</span><span class="p">(</span>
                <span class="n">emit_bitcode_command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">clang</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generating LLVM bitcode benchmark: </span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">emit_bitcode_command</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">bitcode</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">clang</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clang</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BenchmarkInitError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to generate LLVM bitcode with error:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Running command: </span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">emit_bitcode_command</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;From original commandline: </span><span class="si">{</span><span class="n">join_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">bitcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bitcode</span><span class="p">)</span>

        <span class="c1"># If there were multiple sources then link the bitcodes together.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bitcodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">(</span>
                <span class="nb">dir</span><span class="o">=</span><span class="n">transient_cache_path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;llvm-benchmark-&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="nb">dir</span><span class="p">:</span>
                <span class="c1"># Write the bitcodes to files.</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bitcode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bitcodes</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.bc&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bitcode</span><span class="p">)</span>

                <span class="c1"># Link the bitcode files.</span>
                <span class="n">llvm_link_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">llvm_link_path</span><span class="p">()),</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.bc&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bitcodes</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="k">with</span> <span class="n">Popen</span><span class="p">(</span>
                    <span class="n">llvm_link_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">llvm_link</span><span class="p">:</span>
                    <span class="n">bitcode</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">llvm_link</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">llvm_link</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BenchmarkInitError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to link LLVM bitcodes with error: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">BenchmarkFromCommandLine</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">bitcode</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Meta Platforms, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WJN2CKJJKH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WJN2CKJJKH', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>