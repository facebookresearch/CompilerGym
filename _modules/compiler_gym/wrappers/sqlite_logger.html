<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>compiler_gym.wrappers.sqlite_logger &mdash; CompilerGym 0.2.5 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html">
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">RPC Service Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/index.html">LLVM Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../envs/gcc.html">GCC Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../envs/loop_tool.html">loop_tool Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../envs/mlir.html">MLIR Environment Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/compiler_gym.html">compiler_gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/datasets.html">compiler_gym.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/envs.html">compiler_gym.envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/envs/gcc.html">compiler_gym.envs.gcc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/api.html">compiler_gym.envs.llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/leaderboard.html">compiler_gym.leaderboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/service.html">compiler_gym.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/service/runtime.html">compiler_gym.service.runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/spaces.html">compiler_gym.spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/views.html">compiler_gym.views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler_gym/wrappers.html">compiler_gym.wrappers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cc/compiler_gym/envs/llvm/service.html">compiler_gym/envs/llvm/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc/compiler_gym/service.html">compiler_gym/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc/compiler_gym/service/runtime.html">compiler_gym/service/runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc/compiler_gym/util.html">compiler_gym/util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CompilerGym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>compiler_gym.wrappers.sqlite_logger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for compiler_gym.wrappers.sqlite_logger</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>
<span class="sd">&quot;&quot;&quot;This module implements a wrapper that logs state transitions to an sqlite</span>
<span class="sd">database.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">compiler_gym.envs</span> <span class="kn">import</span> <span class="n">LlvmEnv</span>
<span class="kn">from</span> <span class="nn">compiler_gym.spaces</span> <span class="kn">import</span> <span class="n">Reward</span>
<span class="kn">from</span> <span class="nn">compiler_gym.util.gym_type_hints</span> <span class="kn">import</span> <span class="n">ActionType</span>
<span class="kn">from</span> <span class="nn">compiler_gym.util.timer</span> <span class="kn">import</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">humanize_duration</span>
<span class="kn">from</span> <span class="nn">compiler_gym.views</span> <span class="kn">import</span> <span class="n">ObservationSpaceSpec</span>
<span class="kn">from</span> <span class="nn">compiler_gym.wrappers</span> <span class="kn">import</span> <span class="n">CompilerEnvWrapper</span>

<span class="n">DB_CREATION_SCRIPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS States (</span>
<span class="s2">  benchmark_uri TEXT NOT NULL,         -- The URI of the benchmark.</span>
<span class="s2">  done INTEGER NOT NULL,               -- 0 = False, 1 = True.</span>
<span class="s2">  ir_instruction_count_oz_reward REAL NULLABLE,</span>
<span class="s2">  state_id TEXT NOT NULL,              -- 40-char sha1.</span>
<span class="s2">  actions TEXT NOT NULL,               -- Decode: [int(x) for x in field.split()]</span>
<span class="s2">  PRIMARY KEY (benchmark_uri, actions),</span>
<span class="s2">  FOREIGN KEY (state_id) REFERENCES Observations(state_id) ON UPDATE CASCADE</span>
<span class="s2">);</span>

<span class="s2">CREATE TABLE IF NOT EXISTS Observations (</span>
<span class="s2">    state_id TEXT NOT NULL,            -- 40-char sha1.</span>
<span class="s2">    ir_instruction_count INTEGER NOT NULL,</span>
<span class="s2">    compressed_llvm_ir BLOB NOT NULL,           -- Decode: zlib.decompress(...)</span>
<span class="s2">    pickled_compressed_programl BLOB NOT NULL,  -- Decode: pickle.loads(zlib.decompress(...))</span>
<span class="s2">    autophase TEXT NOT NULL,                    -- Decode: np.array([int(x) for x in field.split()], dtype=np.int64)</span>
<span class="s2">    instcount TEXT NOT NULL,                    -- Decode: np.array([int(x) for x in field.split()], dtype=np.int64)</span>
<span class="s2">    PRIMARY KEY (state_id)</span>
<span class="s2">);</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SynchronousSqliteLogger"><a class="viewcode-back" href="../../../compiler_gym/wrappers.html#compiler_gym.wrappers.SynchronousSqliteLogger">[docs]</a><span class="k">class</span> <span class="nc">SynchronousSqliteLogger</span><span class="p">(</span><span class="n">CompilerEnvWrapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper for an LLVM environment that logs all transitions to an sqlite</span>
<span class="sd">    database.</span>

<span class="sd">    Wrap an existing LLVM environment and then use it as per normal:</span>

<span class="sd">        &gt;&gt;&gt; env = SynchronousSqliteLogger(</span>
<span class="sd">        ...     env=gym.make(&quot;llvm-autophase-ic-v0&quot;),</span>
<span class="sd">        ...     db_path=&quot;example.db&quot;,</span>
<span class="sd">        ... )</span>

<span class="sd">    Connect to the database file you specified:</span>

<span class="sd">    .. code-block::</span>
<span class="sd">        $ sqlite3 example.db</span>

<span class="sd">    There are two tables:</span>

<span class="sd">    1. States: records every unique combination of benchmark + actions. For each</span>
<span class="sd">       entry, records an identifying state ID, the episode reward, and whether</span>
<span class="sd">       the episode is terminated:</span>

<span class="sd">    .. code-block::</span>

<span class="sd">        sqlite&gt; .mode markdown</span>
<span class="sd">        sqlite&gt; .headers on</span>
<span class="sd">        sqlite&gt; select * from States limit 5;</span>
<span class="sd">        |      benchmark_uri       | done | ir_instruction_count_oz_reward |                                 state_id | actions |</span>
<span class="sd">        |--------------------------|------|--------------------------------|------------------------------------------|----------------|</span>
<span class="sd">        | generator://csmith-v0/99 | 0    | 0.0                            | d625b874e58f6d357b816e21871297ac5c001cf0 |                |</span>
<span class="sd">        | generator://csmith-v0/99 | 0    | 0.0                            | d625b874e58f6d357b816e21871297ac5c001cf0 | 31             |</span>
<span class="sd">        | generator://csmith-v0/99 | 0    | 0.0                            | 52f7142ef606d8b1dec2ff3371c7452c8d7b81ea | 31 116         |</span>
<span class="sd">        | generator://csmith-v0/99 | 0    | 0.268005818128586              | d8c05bd41b7a6c6157b6a8f0f5093907c7cc7ecf | 31 116 103     |</span>
<span class="sd">        | generator://csmith-v0/99 | 0    | 0.288621664047241              | c4d7ecd3807793a0d8bc281104c7f5a8aa4670f9 | 31 116 103 109 |</span>

<span class="sd">    2. Observations: records pickled, compressed, and text observation values</span>
<span class="sd">       for each unique state.</span>

<span class="sd">    Caveats of this implementation:</span>

<span class="sd">    1. Only :class:`LlvmEnv &lt;compiler_gym.envs.LlvmEnv&gt;` environments may be</span>
<span class="sd">       wrapped.</span>

<span class="sd">    2. The wrapped environment must have an observation space and reward space</span>
<span class="sd">       set.</span>

<span class="sd">    3. The observation spaces and reward spaces that are logged to database</span>
<span class="sd">       are hardcoded. To change what is recorded, you must copy and modify this</span>
<span class="sd">       implementation.</span>

<span class="sd">    4. Writing to the database is synchronous and adds significant overhead to</span>
<span class="sd">       the compute cost of the environment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SynchronousSqliteLogger.__init__"><a class="viewcode-back" href="../../../compiler_gym/wrappers.html#compiler_gym.wrappers.SynchronousSqliteLogger.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">LlvmEnv</span><span class="p">,</span>
        <span class="n">db_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">commit_frequency_in_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">max_step_buffer_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param env: The environment to wrap.</span>

<span class="sd">        :param db_path: The path of the database to log to. This file may</span>
<span class="sd">            already exist. If it does, new entries are appended. If the files</span>
<span class="sd">            does not exist, it is created.</span>

<span class="sd">        :param commit_frequency_in_seconds: The maximum amount of time to elapse</span>
<span class="sd">            before writing pending logs to the database.</span>

<span class="sd">        :param max_step_buffer_length: The maximum number of calls to</span>
<span class="sd">            :code:`step()` before writing pending logs to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;unwrapped&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Requires LlvmEnv base environment&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unwrapped</span><span class="p">,</span> <span class="n">LlvmEnv</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Requires LlvmEnv base environment&quot;</span><span class="p">)</span>
        <span class="n">db_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_frequency</span> <span class="o">=</span> <span class="n">commit_frequency_in_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_step_buffer_length</span> <span class="o">=</span> <span class="n">max_step_buffer_length</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">DB_CREATION_SCRIPT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_commit</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observations_buffer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># House keeping notice: Keep these lists in sync with record().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;IrSha1&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;Ir&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;Programl&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;Autophase&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;InstCount&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewards</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;IrInstructionCountOz&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;IrInstructionCount&quot;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewards</span><span class="p">))</span></div>

<div class="viewcode-block" id="SynchronousSqliteLogger.flush"><a class="viewcode-back" href="../../../compiler_gym/wrappers.html#compiler_gym.wrappers.SynchronousSqliteLogger.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Flush the buffered steps and observations to database.&quot;&quot;&quot;</span>
        <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_observations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations_buffer</span><span class="p">)</span>

        <span class="c1"># Nothing to flush.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n_steps</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">flush_time</span><span class="p">:</span>
            <span class="c1"># House keeping notice: Keep these statements in sync with record().</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
                <span class="s2">&quot;INSERT OR IGNORE INTO States VALUES (?, ?, ?, ?, ?)&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
                <span class="s2">&quot;INSERT OR IGNORE INTO Observations VALUES (?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span>
                <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations_buffer</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observations_buffer</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Wrote </span><span class="si">%d</span><span class="s2"> state records and </span><span class="si">%d</span><span class="s2"> observations in </span><span class="si">%s</span><span class="s2">. Last flush </span><span class="si">%s</span><span class="s2"> ago&quot;</span><span class="p">,</span>
            <span class="n">n_steps</span><span class="p">,</span>
            <span class="n">n_observations</span><span class="p">,</span>
            <span class="n">flush_time</span><span class="p">,</span>
            <span class="n">humanize_duration</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_commit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_commit</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">multistep</span><span class="p">(</span>
            <span class="n">actions</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">observation_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observations</span><span class="p">,</span>
            <span class="n">reward_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewards</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">done</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reset() failed! </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">(</span>
            <span class="n">actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span>
            <span class="n">observations</span><span class="o">=</span><span class="n">observations</span><span class="p">,</span>
            <span class="n">rewards</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span><span class="p">,</span>
            <span class="n">done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">observation</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">ActionType</span><span class="p">,</span>
        <span class="n">observation_spaces</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ObservationSpaceSpec</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reward_spaces</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reward</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">observations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ObservationSpaceSpec</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rewards</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reward</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span> <span class="s2">&quot;No observation space set&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_space</span><span class="p">,</span> <span class="s2">&quot;No reward space set&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">observation_spaces</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;SynchronousSqliteLogger does not support observation_spaces&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">reward_spaces</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;SynchronousSqliteLogger does not support reward_spaces&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">observations</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;SynchronousSqliteLogger does not support observations&quot;</span>
        <span class="k">assert</span> <span class="n">rewards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;SynchronousSqliteLogger does not support rewards&quot;</span>

        <span class="n">observations</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">observation_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observations</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_space_spec</span><span class="p">],</span>
            <span class="n">reward_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewards</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_space</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span> <span class="o">+=</span> <span class="n">rewards</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">(</span>
            <span class="n">actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span>
            <span class="n">observations</span><span class="o">=</span><span class="n">observations</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">rewards</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reward_totals</span><span class="p">,</span>
            <span class="n">done</span><span class="o">=</span><span class="n">done</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rewards</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state_id</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">programl</span><span class="p">,</span> <span class="n">autophase</span><span class="p">,</span> <span class="n">instcount</span><span class="p">,</span> <span class="n">instruction_count</span> <span class="o">=</span> <span class="n">observations</span>
        <span class="n">instruction_count_reward</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rewards</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">uri</span><span class="p">),</span>
                <span class="mi">1</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">instruction_count_reward</span><span class="p">,</span>
                <span class="n">state_id</span><span class="p">,</span>
                <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observations_buffer</span><span class="p">[</span><span class="n">state_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">instruction_count</span><span class="p">,</span>
            <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
            <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">programl</span><span class="p">)),</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">autophase</span><span class="p">),</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">instcount</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_step_buffer_length</span>
            <span class="ow">or</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_commit</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_frequency</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Meta Platforms, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WJN2CKJJKH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WJN2CKJJKH', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>