<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MLIR Environment Reference &mdash; CompilerGym 0.2.5 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="compiler_gym" href="../compiler_gym/compiler_gym.html" />
    <link rel="prev" title="loop_tool Environment Reference" href="loop_tool.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rpc.html">RPC Service Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environments</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../llvm/index.html">LLVM Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcc.html">GCC Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="loop_tool.html">loop_tool Environment Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MLIR Environment Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#environment-configuration">Environment Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#observation-space">Observation Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reward-space">Reward Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="#action-space">Action Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rl-wrapper">RL Wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-usage">Example Usage</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/compiler_gym.html">compiler_gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/datasets.html">compiler_gym.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/envs.html">compiler_gym.envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/envs/gcc.html">compiler_gym.envs.gcc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../llvm/api.html">compiler_gym.envs.llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/leaderboard.html">compiler_gym.leaderboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/service.html">compiler_gym.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/service/runtime.html">compiler_gym.service.runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/spaces.html">compiler_gym.spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/views.html">compiler_gym.views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_gym/wrappers.html">compiler_gym.wrappers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cc/compiler_gym/envs/llvm/service.html">compiler_gym/envs/llvm/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc/compiler_gym/service.html">compiler_gym/service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc/compiler_gym/service/runtime.html">compiler_gym/service/runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc/compiler_gym/util.html">compiler_gym/util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CompilerGym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>MLIR Environment Reference</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/envs/mlir.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mlir-environment-reference">
<h1>MLIR Environment Reference<a class="headerlink" href="#mlir-environment-reference" title="Permalink to this heading"></a></h1>
<p><strong>⚠️ Under construction ⚠️</strong>. In its current state as a MVP, the MLIR
environment exposes benchmarks and an action space geared towards optimization
of matrix multiplication. The environment is not yet included in the CompilerGym
pypi package and must be built from source. See <a class="reference external" href="https://github.com/facebookresearch/CompilerGym/issues/669">here</a> for context.</p>
<p>The MLIR environment exposes configuration of MLIR optimization passes that are
related to matrix multiplication. It compiles and runs MLIR code that computes
matrix multiplication.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span>
</pre></div>
</div>
<p>where <code class="code docutils literal notranslate"><span class="pre">A</span></code> is an <code class="code docutils literal notranslate"><span class="pre">MxK</span></code> matrix and <code class="code docutils literal notranslate"><span class="pre">B</span></code> is an <code class="code docutils literal notranslate"><span class="pre">KxN</span></code> matrix.</p>
<p>Each episode is only 1 step long. All optimization parameters are supplied in a
single action.</p>
<section id="environment-configuration">
<h2>Environment Configuration<a class="headerlink" href="#environment-configuration" title="Permalink to this heading"></a></h2>
<p>M, N and K are benchmark parameters that initialize the environment and can not
be changed.</p>
</section>
<section id="observation-space">
<h2>Observation Space<a class="headerlink" href="#observation-space" title="Permalink to this heading"></a></h2>
<p>The observation is the running time of the calculation.</p>
</section>
<section id="reward-space">
<h2>Reward Space<a class="headerlink" href="#reward-space" title="Permalink to this heading"></a></h2>
<p>The reward is negative running time.</p>
</section>
<section id="action-space">
<h2>Action Space<a class="headerlink" href="#action-space" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compiler_gym.spaces</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Box</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Discrete</span><span class="p">,</span>
    <span class="n">NamedDiscrete</span><span class="p">,</span>
    <span class="n">Permutation</span><span class="p">,</span>
    <span class="n">Scalar</span><span class="p">,</span>
    <span class="n">SpaceSequence</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">action_space</span> <span class="o">=</span> <span class="n">SpaceSequence</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MatrixMultiplication&quot;</span><span class="p">,</span>
    <span class="n">size_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="n">space</span><span class="o">=</span><span class="n">Dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">spaces</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;tile_options&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">spaces</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;interchange_vector&quot;</span><span class="p">:</span> <span class="n">Permutation</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">scalar_range</span><span class="o">=</span><span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;tile_sizes&quot;</span><span class="p">:</span> <span class="n">Box</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;promote&quot;</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
                    <span class="s2">&quot;promote_full_tile&quot;</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;loop_type&quot;</span><span class="p">:</span> <span class="n">NamedDiscrete</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loops&quot;</span><span class="p">,</span> <span class="s2">&quot;affine_loops&quot;</span><span class="p">],</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="s2">&quot;vectorize_options&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">spaces</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;vectorize_to&quot;</span><span class="p">:</span> <span class="n">NamedDiscrete</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="s2">&quot;matmul&quot;</span><span class="p">,</span> <span class="s2">&quot;outer_product&quot;</span><span class="p">],</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;vector_transfer_split&quot;</span><span class="p">:</span> <span class="n">NamedDiscrete</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;linalg_copy&quot;</span><span class="p">,</span> <span class="s2">&quot;vector_transfer&quot;</span><span class="p">],</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;unroll_vector_transfers&quot;</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="nb">min</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="nb">max</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that not all optimization pass configurations are valid and some will
result in an error.</p>
</section>
<section id="rl-wrapper">
<h2>RL Wrapper<a class="headerlink" href="#rl-wrapper" title="Permalink to this heading"></a></h2>
<p>The environment uses some non OpenAI Gym spaces in the action space. To be able
to train with off-the-shelf RL frameworks there is a wrapper (constructed using
<code class="xref py py-func docutils literal notranslate"><span class="pre">compiler_gym.wrappers.mlir.make_mlir_rl_wrapper_env()</span></code>) that converts the
action space to use only OpenAI Gym spaces.</p>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading"></a></h2>
<p>The environment requires LLVM 14 and it can be built only with CMake, not with
Bazel. It is incompatible with the LLVM environment due to LLVM version
conflict. To enable the MLIR environment use these CMake variables.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COMPILER_GYM_ENABLE_MLIR_ENV</span><span class="o">=</span><span class="n">ON</span>
<span class="n">COMPILER_GYM_ENABLE_LLVM_ENV</span><span class="o">=</span><span class="n">OFF</span>
</pre></div>
</div>
<p>This configuration will include the MLIR environment in the <cite>compiler_gym</cite>
Python package. The package will be available under
<cite>${CMAKE_BINARY_DIR}/py_pkg/dist</cite>.</p>
<p>The build can automatically download and build the LLVM 14 dependency.
Instead you can build against a prebuilt LLVM.
To do that pass to CMake these variables</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COMPILER_GYM_LLVM_PROVIDER</span><span class="o">=</span><span class="n">external</span>

<span class="c1"># path to LLVMConfig.cmake directory.</span>
<span class="c1"># e.g. clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04/lib/cmake/llvm</span>
<span class="n">LLVM_DIR</span>

<span class="c1"># path to MLIRConfig.cmake directory.</span>
<span class="c1"># e.g. clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04/lib/cmake/mlir</span>
<span class="n">MLIR_DIR</span>

<span class="c1"># path to ClangConfig.cmake directory</span>
<span class="c1"># e.g. clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04/lib/cmake/clang</span>
<span class="n">Clang_DIR</span>
</pre></div>
</div>
</section>
<section id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">from</span> <span class="nn">compiler_gym.wrappers.mlir</span> <span class="kn">import</span> <span class="n">make_mlir_rl_wrapper_env</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;mlir-v0&quot;</span><span class="p">)</span>
<span class="n">wrapper</span> <span class="o">=</span> <span class="n">make_mlir_rl_wrapper_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="n">wrapper</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="loop_tool.html" class="btn btn-neutral float-left" title="loop_tool Environment Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../compiler_gym/compiler_gym.html" class="btn btn-neutral float-right" title="compiler_gym" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Meta Platforms, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WJN2CKJJKH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WJN2CKJJKH', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>